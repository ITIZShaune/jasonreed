<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget - Jason Reed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: rgba(99, 102, 241, 0.15);
            --bg-site: #0f172a; 
            --card-bg: rgba(30, 41, 59, 0.7); 
            --border-color: rgba(255, 255, 255, 0.08);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-site);
            color: #f1f5f9;
            transition: background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background-image: radial-gradient(circle at top right, rgba(99, 102, 241, 0.05), transparent),
                              radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.03), transparent);
        }
        
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, border-color 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .hover-bg-primary:hover { background-color: var(--primary-hover); }
        
        .input-dark {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            color: #f1f5f9;
            transition: all 0.2s ease;
        }

        .input-dark:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        select option {
            background-color: #1e293b;
            color: #f1f5f9;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="min-h-screen">

    <!-- En-tête / Navigation -->
    <nav class="border-b border-white/5 bg-slate-900/40 backdrop-blur-xl sticky top-0 z-30">
        <div class="max-w-5xl mx-auto px-6">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-primary p-2.5 rounded-xl shadow-lg shadow-primary/20 transition-all duration-500">
                        <i data-lucide="zap" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold tracking-tight text-white">Jason Reed</h1>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Finance Automatisée</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleThemeModal()" class="p-2.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all">
                        <i data-lucide="palette" class="w-5 h-5"></i>
                    </button>
                    <button onclick="openBudgetList()" class="hidden sm:flex items-center gap-2 px-4 py-2.5 text-sm font-semibold text-slate-300 hover:text-white transition-all">
                        <i data-lucide="layers" class="w-4 h-4"></i>
                        Archives
                    </button>
                    <button onclick="checkAndCreateWeeklyBudget()" class="bg-primary/20 text-primary border border-primary/30 px-4 py-2.5 rounded-xl text-sm font-bold transition-all hover:bg-primary hover:text-white flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span class="hidden md:inline">Actualiser Semaine</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 py-10">
        
        <!-- Dashboard Intro -->
        <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div class="space-y-1">
                <h2 id="currentBudgetName" class="text-3xl font-bold text-white tracking-tight italic">Initialisation...</h2>
                <div class="flex items-center gap-2 text-slate-400">
                    <i data-lucide="calendar" class="w-4 h-4 text-primary"></i>
                    <span id="currentDateDisplay" class="text-sm font-medium">--</span>
                </div>
            </div>
            <div class="flex gap-3">
                <div class="bg-emerald-500/10 text-emerald-400 px-4 py-2 rounded-lg border border-emerald-500/20 text-xs font-bold flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Auto-génération active
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass-card p-7 rounded-[24px] relative overflow-hidden group">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Revenus semaine</p>
                <div id="totalIncome" class="text-3xl font-bold text-emerald-400">0,00 €</div>
            </div>

            <div class="glass-card p-7 rounded-[24px] relative overflow-hidden group">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Dépenses semaine</p>
                <div id="totalExpenses" class="text-3xl font-bold text-rose-400">0,00 €</div>
            </div>

            <div class="glass-card p-7 rounded-[24px] relative overflow-hidden border-primary/20 bg-primary/5 group">
                <p class="text-slate-300 text-xs font-bold uppercase tracking-widest mb-2">Solde actuel</p>
                <div id="netBalance" class="text-3xl font-black text-white">0,00 €</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <!-- Formulaire -->
            <div class="lg:col-span-4">
                <div class="glass-card p-8 rounded-[28px] sticky top-28">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-2 h-8 bg-primary rounded-full"></div>
                        <h3 id="formTitle" class="text-xl font-bold text-white">Nouvelle entrée</h3>
                    </div>
                    
                    <form id="transactionForm" class="space-y-5">
                        <input type="hidden" id="editId">
                        
                        <!-- Désignation par menu déroulant -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Désignation</label>
                            <select id="presetSelect" onchange="handleDesignationChange()" class="input-dark w-full px-4 py-3 rounded-xl focus:ring-primary cursor-pointer mb-3">
                                <option value="" disabled selected>Choisir une catégorie...</option>
                                <option value="Mécano">Mécano</option>
                                <option value="Immobilier">Immobilier</option>
                                <option value="Restaurant">Restaurant</option>
                                <option value="SAHP">SAHP</option>
                                <option value="SAMS">SAMS</option>
                                <option value="Travail">Travail</option>
                                <option value="Facture Personnelle">Facture Personnelle</option>
                                <option value="Autre">Autre...</option>
                            </select>
                            <!-- Champ caché qui s'affiche si "Autre" est sélectionné -->
                            <input type="text" id="otherDescription" placeholder="Précisez la désignation..." class="hidden input-dark w-full px-4 py-3 rounded-xl focus:ring-primary">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Montant (€)</label>
                                <input type="number" id="amount" step="0.01" required placeholder="0.00" class="input-dark w-full px-4 py-3 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Type</label>
                                <select id="type" class="input-dark w-full px-4 py-3 rounded-xl cursor-pointer">
                                    <option value="expense">Dépense</option>
                                    <option value="income">Revenu</option>
                                </select>
                            </div>
                        </div>
                        <div class="pt-4 space-y-3">
                            <button type="submit" id="submitBtn" class="w-full bg-primary hover-bg-primary text-white font-bold py-4 rounded-xl transition-all shadow-xl shadow-primary/20 flex items-center justify-center gap-2">
                                <i data-lucide="check" class="w-5 h-5"></i>
                                Enregistrer
                            </button>
                            <button type="button" id="cancelEdit" class="hidden w-full py-3 text-slate-400 hover:text-white font-semibold transition-all" onclick="resetForm()">
                                Annuler
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Liste des transactions -->
            <div class="lg:col-span-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        Opérations de la semaine
                        <span id="transCount" class="bg-white/10 text-slate-400 text-[10px] px-2 py-0.5 rounded-full">0</span>
                    </h3>
                </div>

                <div id="transactionList" class="space-y-4"></div>

                <div id="emptyState" class="hidden py-20 text-center glass-card rounded-[28px]">
                    <p class="text-slate-500 font-medium italic">Commencez à noter vos dépenses pour cette semaine.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modales -->
    <div id="budgetModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-6">
        <div class="glass-card bg-slate-900 w-full max-w-md rounded-[32px] overflow-hidden border-white/10 shadow-2xl">
            <div class="p-8 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white">Historique Hebdomadaire</h3>
                <button onclick="closeBudgetModal()" class="text-slate-500 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="budgetListItems" class="p-6 max-h-[50vh] overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <div id="themeModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-6">
        <div class="glass-card bg-slate-900 w-full max-w-lg rounded-[32px] overflow-hidden border-white/10 shadow-2xl">
            <div class="p-8 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white">Apparence</h3>
                <button onclick="toggleThemeModal()" class="text-slate-500 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8 grid grid-cols-2 sm:grid-cols-3 gap-4" id="themeGrid"></div>
        </div>
    </div>

    <!-- Toast UI -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 bg-primary text-white rounded-2xl shadow-2xl text-sm font-bold translate-y-32 opacity-0 transition-all duration-500 z-50 flex items-center gap-3">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toastMsg">Action effectuée</span>
    </div>

    <script>
        const themes = [
            { id: 'indigo', name: 'Néon Indigo', primary: '#6366f1', hover: '#4f46e5', bg: '#0f172a' },
            { id: 'emerald', name: 'Émeraude Vert', primary: '#10b981', hover: '#059669', bg: '#061a15' },
            { id: 'crimson', name: 'Crimson Rouge', primary: '#f43f5e', hover: '#e11d48', bg: '#1a0d0f' },
            { id: 'gold', name: 'Or Ambre', primary: '#f59e0b', hover: '#d97706', bg: '#1a1406' },
            { id: 'cyan', name: 'Cyber Cyan', primary: '#06b6d4', hover: '#0891b2', bg: '#08161a' },
            { id: 'violet', name: 'Ultra Violet', primary: '#a855f7', hover: '#9333ea', bg: '#140c1f' },
            { id: 'slate', name: 'Monochrome', primary: '#94a3b8', hover: '#64748b', bg: '#111827' },
            { id: 'lime', name: 'Lime Électrique', primary: '#84cc16', hover: '#65a30d', bg: '#0f1406' },
            { id: 'orange', name: 'Magma Orange', primary: '#f97316', hover: '#ea580c', bg: '#1a1006' },
            { id: 'fuchsia', name: 'Fuchsia Laser', primary: '#d946ef', hover: '#c026d3', bg: '#1a081a' }
        ];

        let appData = {
            currentBudgetId: '',
            currentThemeId: 'indigo',
            budgets: {}
        };

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return [d.getUTCFullYear(), weekNo];
        };

        const getCurrentWeeklyId = () => {
            const [year, week] = getWeekNumber(new Date());
            return `${year}-W${week}`;
        };

        const handleDesignationChange = () => {
            const select = document.getElementById('presetSelect');
            const otherInput = document.getElementById('otherDescription');
            if (select.value === 'Autre') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
                otherInput.value = '';
            }
        };

        const checkAndCreateWeeklyBudget = () => {
            const currentId = getCurrentWeeklyId();
            const [year, week] = getWeekNumber(new Date());
            
            if (!appData.budgets[currentId]) {
                appData.budgets[currentId] = {
                    name: `Semaine ${week} - ${year}`,
                    transactions: [],
                    isAutoGenerated: true
                };
                showToast(`Nouveau panneau généré pour S${week}`);
            }
            
            appData.currentBudgetId = currentId;
            saveData();
        };

        const loadData = () => {
            const saved = localStorage.getItem('budgetJasonReed_v3_Weekly');
            if (saved) {
                appData = JSON.parse(saved);
            }
            
            checkAndCreateWeeklyBudget();
            
            applyTheme(appData.currentThemeId || 'indigo');
            document.getElementById('currentDateDisplay').innerText = new Intl.DateTimeFormat('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).format(new Date());
            render();
            renderThemeOptions();
        };

        const saveData = () => {
            localStorage.setItem('budgetJasonReed_v3_Weekly', JSON.stringify(appData));
            render();
        };

        const applyTheme = (themeId) => {
            const theme = themes.find(t => t.id === themeId) || themes[0];
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--primary-hover', theme.hover);
            document.documentElement.style.setProperty('--bg-site', theme.bg);
            document.documentElement.style.setProperty('--primary-light', theme.primary + '26');
            appData.currentThemeId = themeId;
            saveData();
        };

        const renderThemeOptions = () => {
            const grid = document.getElementById('themeGrid');
            grid.innerHTML = themes.map(t => `
                <button onclick="applyTheme('${t.id}')" class="group flex flex-col items-center gap-3 p-4 rounded-2xl border-2 transition-all hover:bg-white/5 ${appData.currentThemeId === t.id ? 'border-primary bg-primary/10' : 'border-white/5'}">
                    <div class="w-10 h-10 rounded-full shadow-lg" style="background-color: ${t.primary}"></div>
                    <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">${t.name}</span>
                </button>
            `).join('');
        };

        const getActiveBudget = () => appData.budgets[appData.currentBudgetId];

        const addTransaction = (description, amount, type) => {
            const budget = getActiveBudget();
            budget.transactions.unshift({
                id: Date.now().toString(),
                description,
                amount: parseFloat(amount),
                type,
                date: new Date().toLocaleDateString('fr-FR', {hour: '2-digit', minute:'2-digit'})
            });
            saveData();
            showToast("Enregistré");
        };

        const updateTransaction = (id, description, amount, type) => {
            const budget = getActiveBudget();
            const idx = budget.transactions.findIndex(t => t.id === id);
            if (idx !== -1) {
                budget.transactions[idx] = { ...budget.transactions[idx], description, amount: parseFloat(amount), type };
                saveData();
                showToast("Mis à jour");
                resetForm();
            }
        };

        const deleteTransaction = (id) => {
            getActiveBudget().transactions = getActiveBudget().transactions.filter(t => t.id !== id);
            saveData();
        };

        const switchBudget = (id) => {
            appData.currentBudgetId = id;
            saveData();
            closeBudgetModal();
            showToast(`Affichage : ${appData.budgets[id].name}`);
        };

        const toggleThemeModal = () => document.getElementById('themeModal').classList.toggle('hidden');
        const openBudgetList = () => { renderBudgetList(); document.getElementById('budgetModal').classList.remove('hidden'); };
        const closeBudgetModal = () => document.getElementById('budgetModal').classList.add('hidden');

        const form = document.getElementById('transactionForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const selectValue = document.getElementById('presetSelect').value;
            const otherValue = document.getElementById('otherDescription').value;
            
            if (!selectValue) {
                showToast("Veuillez choisir une désignation");
                return;
            }

            const desc = selectValue === 'Autre' ? otherValue : selectValue;
            const amt = document.getElementById('amount').value;
            const type = document.getElementById('type').value;
            
            id ? updateTransaction(id, desc, amt, type) : addTransaction(desc, amt, type);
            if (!id) resetForm();
        });

        const startEdit = (id) => {
            const t = getActiveBudget().transactions.find(x => x.id === id);
            document.getElementById('editId').value = t.id;
            
            const select = document.getElementById('presetSelect');
            const otherInput = document.getElementById('otherDescription');
            
            // Vérifier si la description fait partie des options standards
            const standardOptions = Array.from(select.options).map(o => o.value);
            if (standardOptions.includes(t.description) && t.description !== 'Autre') {
                select.value = t.description;
                otherInput.classList.add('hidden');
            } else {
                select.value = 'Autre';
                otherInput.value = t.description;
                otherInput.classList.remove('hidden');
            }

            document.getElementById('amount').value = t.amount;
            document.getElementById('type').value = t.type;
            document.getElementById('formTitle').innerText = "Modification";
            document.getElementById('submitBtn').innerHTML = `<i data-lucide="refresh-cw" class="w-5 h-5"></i> Modifier`;
            document.getElementById('cancelEdit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        };

        const resetForm = () => {
            form.reset();
            document.getElementById('editId').value = "";
            document.getElementById('formTitle').innerText = "Nouvelle entrée";
            document.getElementById('submitBtn').innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Enregistrer`;
            document.getElementById('cancelEdit').classList.add('hidden');
            document.getElementById('otherDescription').classList.add('hidden');
            lucide.createIcons();
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        };

        const render = () => {
            const budget = getActiveBudget();
            if (!budget) return;

            document.getElementById('currentBudgetName').innerText = budget.name;
            let inc = 0, exp = 0;
            budget.transactions.forEach(t => t.type === 'income' ? inc += t.amount : exp += t.amount);
            
            document.getElementById('totalIncome').innerText = inc.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            document.getElementById('totalExpenses').innerText = exp.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            const balance = inc - exp;
            const balanceEl = document.getElementById('netBalance');
            balanceEl.innerText = balance.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            balanceEl.className = `text-3xl font-black ${balance < 0 ? 'text-rose-400' : 'text-white'}`;
            
            document.getElementById('transCount').innerText = budget.transactions.length;

            const listEl = document.getElementById('transactionList');
            const emptyEl = document.getElementById('emptyState');
            listEl.innerHTML = "";

            if (budget.transactions.length === 0) {
                emptyEl.classList.remove('hidden');
            } else {
                emptyEl.classList.add('hidden');
                budget.transactions.forEach(t => {
                    const div = document.createElement('div');
                    div.className = "glass-card p-5 rounded-2xl flex items-center justify-between group animate-in slide-in-from-bottom-2 fade-in";
                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-rose-500/10 text-rose-400'} border border-white/5">
                                <i data-lucide="${t.type === 'income' ? 'trending-up' : 'trending-down'}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-white text-base">${t.description}</h4>
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${t.date}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-black ${t.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}">
                                ${t.type === 'income' ? '+' : '-'}${t.amount.toLocaleString('fr-FR')} €
                            </span>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick="startEdit('${t.id}')" class="p-1.5 text-slate-500 hover:text-white transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                <button onclick="deleteTransaction('${t.id}')" class="p-1.5 text-slate-500 hover:text-rose-400 transition-colors"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
            lucide.createIcons();
        };

        const renderBudgetList = () => {
            const container = document.getElementById('budgetListItems');
            const sortedIds = Object.keys(appData.budgets).sort((a, b) => b.localeCompare(a));
            
            container.innerHTML = sortedIds.map(id => {
                const b = appData.budgets[id];
                const active = id === appData.currentBudgetId;
                return `
                    <div class="flex items-center justify-between p-4 rounded-2xl cursor-pointer border-2 transition-all ${active ? 'border-primary bg-primary/10' : 'border-white/5 bg-white/5 hover:bg-white/10'}" onclick="switchBudget('${id}')">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 flex items-center justify-center rounded-lg ${active ? 'bg-primary text-white' : 'bg-slate-800 text-slate-500'}">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                            </div>
                            <span class="font-bold ${active ? 'text-white' : 'text-slate-300'}">${b.name}</span>
                        </div>
                        ${active ? `<i data-lucide="check-circle" class="text-primary w-5 h-5"></i>` : ''}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        };

        window.onload = loadData;
    </script>
</body>
</html>
